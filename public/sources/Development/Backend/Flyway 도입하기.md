---
created: 2025-03-09 14:25
updated: 2025-03-09 22:08
tags:
  - DB
  - Flyway
---
Flyway를 처음 접한 건 벌써 1년도 더 전의 일이다. 당시에는 필요성을 느끼지 못했기에 그냥 이런 것도 있구나 하고 넘어 갔었다. 그러다 최근 회사에서 서비스 개발을 하던 중 Flyway 도입의 필요성을 느꼈다.

초기 개발 단계다보니 요구사항이 급변했고, 이에 따라 새로운 컬럼이 필요하거나, 기존 컬럼이 변경되는 일이 잦았다. 로컬 환경에서만 개발하는 시기에는 별 문제가 없었지만, 테스트 서버를 올리고 난 이후에 문제가 생겼다.

한 번 스키마 변경이 발생하면 관련 DDL을 로컬 DB에도 적용하고, 테스트 DB에도 적용해야 했다. 그것도 모두 수동으로. 실수로 DDL의 일부를 누락한 적도 있는데, 당연하게도 테스트 서버 동작에 문제가 생겼다. 조만간 운영 서버도 올려야 하고, 그때부터는 DDL을 세 DB에 대해 직접 적용해야 하는데 생각만해도 골치가 아픈 일이다.

게다가 가끔 하던 작업을 다른 PC 환경에서 이어서 할 때도 있는데, 이때는 로컬 DB 환경도 달라지기에 마찬가지로 DDL을 직접 적용해줘야 했다.

이런 이유로 스키마를 자동으로 관리해줄 도구의 필요성을 느꼈고, 예전에 접했던 Flyway가 떠올랐다.
다른 대안이 없을 지를 먼저 찾아봤고, Luquibase라는 도구도 있다는 것을 알게 됐는데 Flyway가 더 간단하게 사용할 수 있다고 판단해 Flyway를 도입하기로 결정했다.
# 의존성 추가
Spring Initializer에서 Flyway starter를 제공하고 있기에 인텔리제이에서 간단하게 의존성을 추가할 수 있다.
Starter로 추가한 DB 드라이버에 따라 자동으로 필요한 의존성을 추가해준다.
![[flyway-starter.png|300]]
![[flyway-dependency.png|400]]
# 설정값 구성
Flyway가 동작하기 위해서는 먼저 application.yml 또는 application.properties 파일에 필요한 설정값을 구성해야 한다.
```yml
spring:
    flyway:
        baseline-on-migration: true
        baseline-version: 1
```

- baseline-on-migration: 기본값은 false다. true로 설정할 경우 Flyway의 스키마 변경 이력을 관리할 테이블인 flyway_schema_history 테이블이 없을 경우 자동으로 생성해준다.
- baseline-version: 현재 스키마 버전을 나타낸다. 해당 버전의 스크립트는 실행되지 않고 다음 버전부터 실행된다. 기본값은 1이므로, 초기 스키마 스크립트를 실행해야 한다면 버전을 0으로 설정하자. 환경 별로 baseline 버전을 다르게 설정해야 하는 경우가 있으니 환경변수로 분리하는 것을 추천한다.
- 이외에도 DB url, user, password를 따로 설정할 수 있다. 생략할 경우 기본 datasource의 설정값을 사용하게 된다.
# 마이그레이션 스크립트 작성
Flyway는 `/src/main/resources/db/` 디렉토리 하위에서 스크립트 파일을 찾는다.
파일의 이름은 `V{버전번호}__{파일이름}.sql` 구조를 가져야 하며 반드시 언더스코어 두개가 버전 번호와 파일 이름 사이에 위치해야 한다.
파일 이름에 언더스코어가 포함되어도 상관없다. `V2__add_new_column.sql`과 같은 형태로 사용해도 된다는 의미다.
# 마이그레이션
이제 애플리케이션을 실행하면 flyway_schema_history 테이블을 참조해 자동으로 필요한 스크립트를 실행해준다.