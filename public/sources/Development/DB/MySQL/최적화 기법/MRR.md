---
created: 2024-08-25 22:45
updated: 2024-08-26 21:36
tags:
  - MySQL
  - DB
  - Database
  - Optimizer
  - 옵티마이저
references:
  - https://dev.mysql.com/doc/refman/8.0/en/mrr-optimization.html
---
# 정의
세컨더리 인덱스에 대한 인덱스 레인지 스캔, 동등 조인 시 발생할 수 있는 랜덤 액세스를 줄이기 위한 최적화 기법이다.
세컨더리 인덱스를 통한 조회를 건 바이 건으로 처리하는 대신 키 값만 조회해서 버퍼에 모은 뒤 한 번에 데이터를 조회하는 방법이다.
# MMR을 사용하지 않을 때의 조회 방식
기본적으로 InnoDB 스토리지 엔진은 클러스터링 인덱스를 사용하기 때문에 세컨더리 인덱스에 대한 인덱스 레인지 스캔은 랜덤한 순서로 정렬된 PK 값들을 반환하게 된다.

예를 들어 사용자 테이블에 사용자의 나이가 저장되어 있고, 나이에 대한 세컨더리 인덱스가 존재할 때 나이가 20살 이상이고, 30살 이하인 사용자들의 이름과 주소를 조회하면 세컨더리 인덱스에 대한 인덱스 레인지 스캔이 발생한다.
그 결과로 세컨더리 인덱스에서 조건에 맞는 튜플을 탐색하고, 튜플에 저장된 PK를 반환하게 된다.
이때 조회되는 PK는 랜덤한 순서를 가지고 있으며, 스토리지 엔진은 한 건의 PK를 조회할 때마다 PK를 통해 레코드를 조회하게 된다. 즉, 랜덤한 순서의 PK를 통한 조회가 발생하며 여기서 디스크에 대한 랜덤 액세스가 발생하게 된다.
# MRR을 사용할 때의 조회 방식
MRR을 사용할 경우 세컨더리 인덱스에서 조회한 PK를 곧바로 데이터 조회에 사용하지 않고 버퍼에 저장한다.
버퍼에 키를 다 쌓고 나면 PK 순으로 버퍼를 정렬한다.
이후에는 정렬된 PK들을 사용해 필요한 데이터를 조회하게 된다.

클러스터링 인덱스에서 PK는 데이터의 저장 위치를 나타내기 때문에 정렬된 순서의 PK를 통한 접근은 순차적인 접근을 보장한다.
다시 말해 랜덤 액세스를 최소화할 수 있으며, 동일한 페이지에 대한 중복 조회도 막을 수 있다.
# 제약 조건
- MRR은 InnoDB 엔진과 MyISAM 엔진의 테이블에서만 지원된다.
- 쿼리 결과를 생성하기 위해 전체 테이블에 접근할 필요가 없는 경우, 다시 말해 인덱스만으로 결과를 반환할 수 있는 경우에는 MRR이 사용되지 않는다.(커버링 인덱스 사용 시에는 MRR 사용 X)
# 관련 설정
`optimizer_switch` 시스템 변수의 플래그를 통해 관련 설정을 활성화/비활성화할 수 있다. 기본적으로 아래 두 플래그는 활성 상태로 제공된다.
- `mrr` 플래그 : MRR의 활성 여부를 제어하는데 사용된다.
- `mrr_cost_based` 플래그 : `mrr` 플래그가 활성화된 경우에 사용할 수 있으며 옵티마이저가 비용 기반으로 MRR의 사용 여부를 결정할 지를 제어할 수 있다.
<br>
- `read_rnd_buffer_size` 시스템 변수 : 여기에 설정된 크기를 MRR 버퍼의 크기로 사용한다. 버퍼 크기가 가득 차면 세컨더리 인덱스를 통한 키 값 조회를 일시 중지하고 레코드 조회를 수행한다. 이후 다시 키 값 조회를 이어나간다.