---
created: 2024-12-25 10:40
updated: 2024-12-25 13:43
tags:
  - AWS
  - IAM
---
AWS에서 사용자 별로 권한을 부여하고 관리할 일이 있어 관련 내용을 찾아보았다.
그런데 생각한 것보다 내용이 복잡해 관련 내용을 정리할 필요를 느꼈다.

먼저 큰 분류로 보자면 AWS에서 제공하는 서비스인 IAM Identity Center를 사용하는 방법과, 루트 계정의 IAM을 사용하는 방법으로 나뉜다.
AWS에서 IAM Identity Center 사용을 권장하고 있으므로 이 글에서는 IAM Identity Center를 사용하는 방법을 위주로 다룰 것이다.
# IAM Identity Center
먼저 IAM Identity Center가 뭘까? 나도 이번에 처음 접한 서비스라 조금 생소했다.

잠깐의 구글링과 챗지피팅을 해본 결과 AWS에서 제공하는 권한 관리 솔루션으로, 기존에 있던 AWS Single Sign-On의 후속 버전이라고 한다.
하나의 콘솔에서 조직에 등록된 여러 AWS 계정에 권한을 할당할 수 있다는 장점이 있고, AWS 관리형 애플리케이션과의 통합을 지원한다고 한다.

사실 이런 내용들이 잘 와닿지는 않았고, 잠깐 사용해본 결과 기존 IAM 방식보다 훨씬 직관적이고 간편하다는 것을 바로 알 수 있었다. 그리고 무료 서비스이므로 사용하지 않을 이유가 없다.
## IAM Identity Center 활성화
루트 계정으로 AWS 콘솔에서 IAM Identity Center를 검색해서 서비스로 이동하자.
그럼 아래와 같은 활성화 버튼을 발견할 수 있다.
![[활성화.png|300]]

활성화 버튼 클릭 시 아래와 같이 구성 방법 선택창이 나타난다.  만약 이미 등록된 Organizations이 있다면 선택창 없이 즉시 조직에 대해 활성화 된다. 조직 생성에 비용이 들지 않으므로 굳이 계정에 대해 활성화할 필요가 없다.
하나 주의할 점이 있는데 활성화 전 반드시 리전을 확인하고 활성화하자. 잘못된 리전에 생성한 경우 인스턴스를 삭제하고 다시 생성하는 번거로운 과정을 거쳐야한다.
![[인스턴스_선택.png|500]]
## 주요 기능들
IAM Identity Center에서 다양한 기능을 제공하지만, 당장 이 모든 기능을 살펴보기는 힘들어 보인다. 게다가 그럴 이유도 없다. 현재 나에게 필요한 기능은 사용자 그룹별로 권한을 설정하는 기능이므로 이와 관련된 기능만 살펴보기로 했다.

참고로 현재 해당 서비스의 번역이 일부만 진행된 탓인지 선택된 메뉴에 따라 언어가 왔다 갔다 한다.
### 권한 세트
권한 세트는 특정 사용자에게 부여하기 위한 권한의 모음이다. 사전 정의된 권한을 사용할 수도 있고, 직접 원하는 권한으로 세트를 생성할 수도 있다.
![[권한세트등록.png|500]]

권한 세트 등록 시에는 아래와 같이 세트의 이름, 세션의 기간 등을 지정할 수 있다.
![[권한세트세부정보.png|500]]
### 그룹
그룹은 여러 사용자를 하나로 묶고, 그룹 내의 사용자에게 동일한 권한을 부여하고자 할때 유용하다. 개별 사용자에게 모두 권한을 부여할 수도 있지만, 생각만해도 비효율적이다. 그룹 생성 시 그룹에 포함시킬 사용자를 지정할 수도 있다.
![[그룹등록.png|600]]
### 사용자
사용자는 실제 AWS 액세스 포털에 로그인할 수 있는 사용자를 의미한다.
사용자 이름은 로그인 시 사용하는 계정명이 되며, 지정된 이메일 주소로 비밀번호를 설정할 수 있는 링크와 액세스 포털의 주소가 전달된다. 아래 정보들 이외에 직책, 직급, 주소 등 사용자의 정보를 추가로 입력할 수도 있다.
![[사용자등록.png|500]]

사용자 등록 시 그룹을 할당할 수 있다.
![[사용자_생성_시_그룹_할당.png|400]]

사용자 등록을 마치면 등록한 이메일로 아래와 같은 메일이 도착한다. 초대 수락 버튼을 클릭하면 가입 페이지로 이동된다.
![[초대이메일.png|400]]

비밀번호의 재설정을 마치면 사용자 가입이 완료된다.
![[비밀번호재설정.png|300]]

비밀번호 재설정이 끝나면 로그인 화면으로 이동된다. 앞서 확인한 사용자 이름과 직접 설정한 비밀번호를 입력한다.
![[로그인.png|300]]

로그인에 성공하면 MFA 디바이스 등록 화면이 나타난다.
MFA 등록 필수 여부와 로그인 시 MFA 요구 등의 설정은 Identity Center의 설정에서 관리할 수 있다.
![[MFA추가.png|400]]
### 액세스 포털
로그인에 성공하면 액세스 포털로 이동된다. 부여된 권한이 없다면 아래와 같은 내용이 표시 된다.
![[포털메인.png]]

부여된 권한이 있다면 계정 별로 할당된 권한 세트 정보가 표시되며, 권한 세트의 이름을 클릭하면 해당 권한으로 AWS 콘솔에 로그인 된다.
![[권한할당후콘솔.png]]
### 권한 부여
사용자에게 권한을 부여하려면 AWS 계정 항목으로 이동한다. 여기서 접근을 허용한 AWS 계정을 선택하고, 사용자 또는 그룹 할당을 선택한다.
![[계정권한부여.png|500]]

그럼 선택된 계정에 대한 접근을 허용할 사용자나 그룹을 선택할 수 있게 된다. 여기서는 앞서 등록했던 그룹을 선택해보자.
![[그룹사용자선택.png|300]]

다음으로 어떤 권한을 부여할 지를 결정해야 한다. 앞서 등록된 권한 세트가 표시되므로 이 권한 세트를 선택하자.
![[권한세트선택.png|300]]

부여된 권한 세트는 액세스 포털에 표시되며, 이를 통해 AWS 콘솔에 접근할 수 있게 된다. 선택된 권한 세트로 로그인한 경우에는 해당 권한 세트에 부여된 권한만 사용할 수 있다.
![[권한할당후콘솔.png|500]]

예를 들어 아래와 같이 여러 권한 세트가 할당된 경우를 보자. EC2 권한으로 로그인하는 경우에는 EC2 권한 세트에 부여된 권한만 사용할 수 있다.
![[멀티_권한.png|200]]

EC2에는 EC2 full access 정책이 부여되었으므로, EC2 리소스에는 접근할 수 있지만, S3 리소스에는 접근할 수 없다.
![[ec2-s3-error.png|300]]

반대로 S3 권한으로 로그인할 경우 EC2 리소스에 접근할 수 없다.
![[s3-ec2-error.png|400]]
# IAM
AWS 콘솔에서 제공하는 사용자 및 권한 관리 도구다.
루트 사용자 하위에 계정을 생성하고, AWS 콘솔 로그인 창을 통해 해당 사용자로 로그인하는 방식으로 사용할 수 있다.

이외에는 AWS 서비스 간에 권한을 부여하기 위해 주로 사용된다. 예를 들어 EC2에서 S3에서 데이터를 읽을 수 있도록 서비스 간 역할을 설정하고 부여할 수 있다.
## 정책
먼저 IAM에서는 정책이라는 객체를 통해 각각의 권한을 정의한다. 사전에 정의된 정책도 많고, 직접 필요한 정책을 구성할 수도 있다.

정책은 아래와 같이 JSON 형태로 구성된다. 아래 정책은 AmazonEC2FullAccess 정책으로 AWS에서 사전 제공되는 정책 중 하나다.
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": "ec2:*",
            "Effect": "Allow",
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "elasticloadbalancing:*",
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "cloudwatch:*",
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "autoscaling:*",
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "iam:CreateServiceLinkedRole",
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "iam:AWSServiceName": [
                        "autoscaling.amazonaws.com",
                        "ec2scheduled.amazonaws.com",
                        "elasticloadbalancing.amazonaws.com",
                        "spot.amazonaws.com",
                        "spotfleet.amazonaws.com",
                        "transitgateway.amazonaws.com"
                    ]
                }
            }
        }
    ]
}
```

최근에는 아래와 같이 시각화된 정보로도 정책을 제공하고 있다.
![[권한.png|300]]

정책 등록 시에도 시각화된 방식으로 각 서비스 별로 필요한 권한을 정책에 담을 수 있다.

이렇게 정의된 정책은 사용자, 사용자 그룹, 역할에 할당될 수 있다.
역할은 주로 AWS 서비스 간의 접근 권한을 제어하기 위해 사용되고, 사용자에 대한 정책은 주로 사용자 그룹에 할당된다.
## 사용자 그룹
사용자 그룹은 여러 사용자에게 동일한 정책을 부여하기 위한 객체다. 사전에 정의된 사용자 그룹에 필요한 정책들을 할당하고, 사용자 생성 시 해당 그룹에 배정하면 그룹에 할당된 정책이 사용자에게 적용된다.

개발자들의 IAM 사용자 계정에 동일한 권한을 부여하거나, DevOps, DBA의 계정 권한을 미리 정의해두는 등의 다양한 용도로 사용할 수 있다.
## 사용자
사용자는 콘솔에 로그인 가능한 IAM 계정을 등록하거나, 외부 애플리케이션에서 AWS 인증을 할 때 사용할 계정을 등록하는 용도로 사용할 수 있다.
계정 등록 시에 콘솔 로그인 여부를 지정할 수 있으며, 계정 별로 액세스 키를 두 개까지 생성할 수 있고, MFA를 추가할 수도 있다.
## 역할
역할은 사용자나 사용자 그룹, AWS 서비스(EC2 인스턴스 등)에 할당될 수 있는 객체다.
AWS 서비스에는 역할만 할당될 수 있으며, 할당된 역할을 통해 다른 AWS 서비스에 대한 접근 권한을 얻을 수 있다.

사용자나 사용자 그룹에 역할을 부여하는 기능은 사용자나 사용자 그룹에 정책을 할당할 수 있기 때문에 사용할 일은 없어 보인다.

외부 시스템에서의 접속을 위한 역할을 생성하는 기능이 추가로 제공되는 것 같은데, 당장 사용할 일이 없어 이 부분에 대해서는 더 알아보지 않았다.
## 권한 경계
권한 경계는 권한의 상한선 역할을 담당한다.
사용자에게 부여된 권한이 권한 경계에도 포함된 경우에만 해당 권한을 가질 수 있다.

예를 들어 특정 사용자에게 다음과 같인 권한과 권한 경계가 부여되었다고 하자.
- 권한 경계 : `s3:PutObject`, `s3:GetObject`
- IAM 정책 : `s3:PutObject`, `s3:DeleteObject`

이때 각 권한의 허용 여부는 아래와 같다.
- `s3:PutObject`는 두 정책에 모두 포함되어 허용된다.
- `s3:GetObject`는 권한 경계에 포함되므로 허용되지만, IAM 정책에 없으면 허용되지 않는다.
- `s3:DeleteObject`는 권한 경계에 없으므로 허용되지 않는다.
